<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Lab 5 Fast Robot - Shihming Lin</title>
        <link href="css/styles.css" rel="stylesheet" />
        <link rel="icon" type="image/x-icon" href="assets/img/project-cover/right_corner_icon.png" />
        <script data-search-pseudo-elements defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js" crossorigin="anonymous"></script>
    </head>
    <body>
        <div id="layoutDefault">
            <div id="layoutDefault_content">
                <main>
                    <!-- Navbar-->
                    <nav class="navbar navbar-marketing navbar-expand-lg bg-white navbar-light">
                        <div class="container px-5">
                            <a class="navbar-brand text-primary" href="index.html"><img class="img-fluid rounded-3" src="assets/img/project-cover/right_corner_icon.png" /></a>
                            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><i data-feather="menu"></i></button>
                            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                                <ul class="navbar-nav ms-auto me-lg-5">
                                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                                    <li class="nav-item dropdown dropdown-xl no-caret">
                                        <a class="nav-link dropdown-toggle" id="navbarDropdownDemos" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Projects
                                            <i class="fas fa-chevron-right dropdown-arrow"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-end animated--fade-in-up me-lg-n25 me-xl-n15" aria-labelledby="navbarDropdownDemos">
                                            <div class="row g-0">
                                                <div class="col-lg-5 p-lg-3 bg-img-cover overlay overlay-primary overlay-70 d-none d-lg-block" style="background-image: url('assets/img/backgrounds/bg-dropdown-xl.jpg')">
                                                    <div class="d-flex h-100 w-100 align-items-center justify-content-center">
                                                        <div class="text-white text-center z-1">
                                                            <div class="mb-3">Will add a image of robots/embedded systems or other related projects</div>
                                                            <a class="btn btn-white btn-sm text-primary fw-500" href="index.html">Show details</a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-7 p-lg-5">
                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <h6 class="dropdown-header text-primary">Web Applications</h6>
                                                            <a class="dropdown-item" href="http://course-enrollment-lsm.s3-website-us-west-2.amazonaws.com/">Course Registration Service</a>
                                                            <a class="dropdown-item" href="https://serene-refuge-47001.herokuapp.com/">Emaily: A Feedback-Collection App</a>
                                                            <a class="dropdown-item" href="#!">E-commerce</a>
                                                            <div class="dropdown-divider border-0"></div>
                                                            <h6 class="dropdown-header text-primary">Robots</h6>
                                                            <a class="dropdown-item" href="fast-robot-all-project-main-page.html">Fast Robot</a>
                                                            <a class="dropdown-item" href="#!">Design and Control of an Autonomous, <br> 4-Legged Construction Robot</a>
                                                            <a class="dropdown-item" href="https://drive.google.com/file/u/3/d/1nS1tiqPLQ61-NSE5_IbpiMUPlx14oYKk/view?usp=sharing">Low-cost Perception System <br> and Remote Management of <br> an Autonomous Wheelchair</a>
                                                            <a class="dropdown-item" href="https://github.com/LexLin004/RelaxU">RelaxU: A Portable And Wearable Massager Tape <br> For Pain Relief and Muscle Recovery</a>
                                                            <div class="dropdown-divider border-0"></div>
                                                            <h6 class="dropdown-header text-primary">FPGA</h6>
                                                            <a class="dropdown-item" href="https://vanhunteradams.com/DE1/Lorenz/Lorenz.html">Hardware ODE solver with HPS control</a>
                                                            <a class="dropdown-item" href="https://vanhunteradams.com/DE1/Mandelbrot/Mandelbrot.html">Mandelbrot Set Visualizer</a>
                                                            <a class="dropdown-item" href="https://vanhunteradams.com/DE1/Drum/Drum_synthesis.html">Multiprocessor Drum Synthesis</a>
                                                            <div class="dropdown-divider border-0 d-lg-none"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="nav-item dropdown dropdown-xl no-caret">
                                        <a class="nav-link dropdown-toggle" id="navbarDropdownPages" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Personal
                                            <i class="fas fa-chevron-right dropdown-arrow"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-end me-lg-n20 me-xl-n15 animated--fade-in-up" aria-labelledby="navbarDropdownPages">
                                            <div class="row g-0">
                                                <div class="col-lg-4 p-lg-5">
                                                    <h6 class="dropdown-header text-primary">Education</h6>
                                                    <a class="dropdown-item" href="#!">One</a>
                                                    <a class="dropdown-item" href="#!">Two</a>
                                                    <div class="dropdown-divider border-0"></div>
                                                    <h6 class="dropdown-header text-primary">Engineering Experience</h6>
                                                    <a class="dropdown-item" href="#!">One</a>
                                                    <a class="dropdown-item" href="#!">Two</a>
                                                    <a class="dropdown-item" href="#!">Three</a>
                                                    <div class="dropdown-divider border-0 d-lg-none"></div>
                                                </div>
                                                <div class="col-lg-4 p-lg-5">
                                                    <h6 class="dropdown-header text-primary">Blogs</h6>
                                                    <a class="dropdown-item" href="page-blog-overview.html">Overview</a>
                                                    <a class="dropdown-item" href="page-blog-post.html">Post</a>
                                                    <a class="dropdown-item" href="page-blog-archive.html">Archive</a>
                                                    <div class="dropdown-divider border-0 d-lg-none"></div>
                                                </div>
                                                <div class="col-lg-4 p-lg-5">
                                                    <h6 class="dropdown-header text-primary">Other Design</h6>
                                                    <a class="dropdown-item" href="#!">1</a>
                                                    <a class="dropdown-item" href="#!">2</a>
                                                    <a class="dropdown-item" href="#!">3</a>
                                                    <a class="dropdown-item" href="#!">4</a>
                                                    <a class="dropdown-item" href="#!">5</a>
                                                    <div class="dropdown-divider border-0 d-lg-none"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="nav-item dropdown no-caret">
                                        <a class="nav-link dropdown-toggle" id="navbarDropdownDocs" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Documentation
                                            <i class="fas fa-chevron-right dropdown-arrow"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-end animated--fade-in-up" aria-labelledby="navbarDropdownDocs">
                                            <a class="dropdown-item py-3" href="https://docs.startbootstrap.com/sb-ui-kit-pro/quickstart" target="_blank">
                                                <div class="icon-stack bg-primary-soft text-primary me-4"><i data-feather="book-open"></i></div>
                                                <div>
                                                    <div class="small text-gray-500">Documentation</div>
                                                    Usage instructions and reference
                                                </div>
                                            </a>
                                            <div class="dropdown-divider m-0"></div>
                                            <a class="dropdown-item py-3" href="https://docs.startbootstrap.com/sb-ui-kit-pro/components" target="_blank">
                                                <div class="icon-stack bg-primary-soft text-primary me-4"><i data-feather="code"></i></div>
                                                <div>
                                                    <div class="small text-gray-500">Components</div>
                                                    Code snippets and reference
                                                </div>
                                            </a>
                                            <div class="dropdown-divider m-0"></div>
                                            <a class="dropdown-item py-3" href="https://docs.startbootstrap.com/sb-ui-kit-pro/changelog" target="_blank">
                                                <div class="icon-stack bg-primary-soft text-primary me-4"><i data-feather="file-text"></i></div>
                                                <div>
                                                    <div class="small text-gray-500">Changelog</div>
                                                    Updates and changes
                                                </div>
                                            </a>
                                        </div>
                                    </li>
                                </ul>
                                <a class="btn fw-500 ms-lg-4 btn-primary" href="fast-robot-all-project-main-page.html">
                                    Back
                                    <i class="ms-2" data-feather="arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </nav>
                    <section class="bg-light py-10">
                        <div class="container px-5">
                            <div class="row gx-5 justify-content-center">
                                <div class="col-lg-10 col-xl-8">
                                    <div class="single-post">
                                        <h1>Lab 5 report (Linear PID control and Linear interpolation)</h1>
                                        <p class="lead">In this <a href="https://fastrobotscornell.github.io/FastRobots/labs/Lab5.html">lab </a>,
                                            I implemented a PID control system, which uses the distance measured by the front ToF sensor, to my car to make it 
                                            perform a task autonomously. The car will drive towards a wall and stop at a set point 300 mm from the wall.
                                        <div class="d-flex align-items-center justify-content-between mb-5">
                                            <div class="single-post-meta me-4">
                                                <img class="single-post-meta-img" src="assets/img/project-cover/right_corner_icon.png" />
                                                <div class="single-post-meta-details">
                                                    <div class="single-post-meta-details-name">Shihming Lin</div>
                                                    <div class="single-post-meta-details-date">Mar 13, 2024</div>
                                                </div>
                                            </div>
                                            <div class="single-post-meta-links">
                                                <a href="https://www.linkedin.com/in/shihming-lin-597008199"><i class="fab fa-linkedin fa-fw"></i></a>
                                                <a href="https://github.com/LexLin004"><i class="fab fa-github fa-fw"></i></a>
                                                <a href="https://github.com/robotconstruction"><i class="fab fa-github fa-fw"></i></a>
                                            </div>
                                        </div>
                                        <div class="single-post-text my-5">
                                            <h2>Prelab</h2>
                                            <h5>Sending and Receiving Data over BLE</h5>
                                            <p> 
                                                I built the send and receive data mechanism using code from a previous lab. I added command 'SET_PID' to set 
                                                new PID coefficients and robot running time and command 'MOVE_TOWARD_WALL' to control it move toward the wall.
                                                I created a new array to store the PID values (error, integral, derivative), tof values (current distance
                                                measured, time of current distance measured, previous distance measured, time of previous distance measured), and 
                                                intermediate value (interpolated distance, filtered derivative value). All of these value are stored in a struct,
                                                and then stored in a struct array. 
                                            </p>
                                            <script src="https://gist.github.com/LexLin004/3a41574ae50810c73b675427cec2a63e.js"></script>
                                            <p>In the python script, I just send the command and store the strings sent from Artemis for future analysis.</p>
                                            <script src="https://gist.github.com/LexLin004/4f50cd4f9b08ce8a58413a0d4678a337.js"></script>

                                            <h2>Lab tasks</h2>
                                            <h3>P/I/D discussion</h3>

                                            <p>
                                                In this lab, I used the long distance mode of the tof (4m measurement distance). According to the last lab measurement,
                                                the effective operating range of my motor is 7500-65535 (16bit analogread resolution) when the car is moving on the lab floor.
                                                And since the output distance unit of TOF is mm, the frequency is about 85-100ms at a time, I think the coefficient of P,I,D 
                                                should be 0.01 and below. 
                                            </p>
                                            <p>
                                                A value of less than 0.01 prevents P*error from calculating a huge value, or a large derivative value due to a large error 
                                                rate of change between two updates of the tof. This also reduces the effect of the millimeter-integral cumulative error 
                                                (although I later used integral isolation). If the values of these three controllers are too large, it can lead to a crash.
                                            </p>
                                            <p>
                                                To increase the frequency of tof updates, although I didn't use setProxIntegrationTime in tof_pololu's library, I lowered 
                                                the timing budget using setTimingBudgetInMs(50). According to the tof lab, If this value is lowered, there will be a slight
                                                decrease in accuracy, but it is acceptable because it improves the number of times the error is corrected by the TOF value.
                                            </p>
                                            <p>
                                                The reason I chose to use a combination of P, I, and D controllers is because the P controller can influence the pwm output 
                                                based on the current error; integral-isolated I controller prevents the car from stopping at a position that is some distance 
                                                away from the target point, because the integral controller can accumulate value over time, which increases the PID output
                                                and thus the pwm value, causing the motor to start spinning again; D controller can dampen rapid changes in error and reduce overshoot
                                                when the car is a fast moving system.
                                            </p>
                                            
                                            <h3>Implementation</h3>
                                            <p>
                                                In the code, I used curr_distance_pid and curr_time_pid to record the current distance from the wall and the time of measurement. 
                                                I used previous_error_pid and last_time_pid to record the value and time of the last calculated error.
                                                I used prev_distance_pid, prev_time_pid to record the distance and measurement time of the last time.
                                                In the section of the main loop of moving toward wall, I discussed two scenarios: 1. the tof returned a reading, and 2. the tof did not return a reading.
                                                In the first case, the current and previous distance and time are updated directly and the slope between this and the previous TOF return value is computed
                                                to allow for the operation of interpolation in the absence of TOF return data.
                                                In the second case, I calculate dthe interpolated distance and use this to update the current and previous distance and time.
                                            </p>
                                            <p>
                                                After that, I calculated the p, i, and d value needed for the pid, and record the values into an array for subsequent sending to the computer via BLE.
                                                I chose to use integral isolation for the integral value to prevent it from accumulating errors at the beginning of the run, which would result
                                                 in excessive speed and hitting the wall.
                                                 I chose to filter the derivative value using a low pass filter to get a smooth value. I chose to use linear interpolation to calculate the predicted
                                                 distance when the tof is not ready, so as to avoid losing control of the robot.
                                            </p>
                                            <script src="https://gist.github.com/LexLin004/c96a818b8fb1634cbdef8e3092f2b8f2.js"></script>

                                            <h3>Result</h3>
                                            <p>
                                                In the following demo, the coefficients of PID is P:0.03,I:0.001,and D:0.05.
                                            </p>
                                            <p>
                                                In the video below, I demonstrate how my PID controller behaves when placing the robot 8 grids (2.4meter) from the wall. As the video shows, the car stops before hitting the wall and slowly backs up to setpoint.
                                                
                                                In the plot, I plotted the current distance from the wall against the current time. In this plot, the blue dots indicate all current distances and the orange "x" 
                                                indicates the distance measured by the tof. I also plotted the current motor input versus the current time. Since I processed the motor input so that it is only 
                                                positive. If the car needs to be rotated backwards, an int will be passed to the control_motor function so that it rotates backwards with the motor input shown in the graph.

                                            </p>
                                            <iframe width="560" height="315" src="https://youtube.com/embed/Jiu2pHKQH28"> </iframe>
                                            <img width=500 class="img-fluid mb-2 rounded" src="assets/img/lab_assets/lab5_assets/plotForLab5/test_1_cdvsct.png" />
                                            <div class="small text-gray-500">Figure 1:Test 1, Current Distance vs Current Time</div>
                                            <img width=500 class="img-fluid mb-2 rounded" src="assets/img/lab_assets/lab5_assets/plotForLab5/test_1_cmivsct.png" />
                                            <div class="small text-gray-500">Figure 2:Test 1, Current Motor Input vs Current Time</div>

                                            <p>
                                                In the video below, I demonstrate how my PID controller behaves when placing the robot 9 grids (2.7meter) from the wall. As the video shows, the car stops before hitting the wall and slowly backs up to setpoint.
                                            </p>
                                            <iframe width="560" height="315" src="https://youtube.com/embed/-ZETIZWHwjI"> </iframe>
                                            <img width=500 class="img-fluid mb-2 rounded" src="assets/img/lab_assets/lab5_assets/plotForLab5/test_2_cdvsct.png" />
                                            <div class="small text-gray-500">Figure 3:Test 2, Current Distance vs Current Time</div>
                                            <img width=500 class="img-fluid mb-2 rounded" src="assets/img/lab_assets/lab5_assets/plotForLab5/test_2_cmivsct.png" />
                                            <div class="small text-gray-500">Figure 4:Test 2, Current Motor Input vs Current Time</div>

                                            <p>
                                                In the video below, I demonstrate how my PID controller behaves when placing the robot 7.5 grids (2.3meter) from the wall. As the video shows, the car stops before hitting the wall and slowly backs up to setpoint.
                                            </p>
                                            <iframe width="560" height="315" src="https://youtube.com/embed/JKvy3YkQKOI"> </iframe>
                                            <img width=500 class="img-fluid mb-2 rounded" src="assets/img/lab_assets/lab5_assets/plotForLab5/test_3_cdvsct.png" />
                                            <div class="small text-gray-500">Figure 5:Test 3, Current Distance vs Current Time</div>
                                            <img width=500 class="img-fluid mb-2 rounded" src="assets/img/lab_assets/lab5_assets/plotForLab5/test_3_cmivsct.png" />
                                            <div class="small text-gray-500">Figure 6:Test 3, Current Motor Input vs Current Time</div>

                                            <p>
                                                In the video below, I demonstrate how my PID controller behaves when placing the robot 3.5 grids (1meter) from the wall. As the video shows, the car stops at the setpoint and shakes for a while .
                                            </p>
                                            <iframe width="560" height="315" src="https://youtube.com/embed/mnr-cNb13fw"> </iframe>
                                            <iframe width="560" height="315" src="https://youtube.com/embed/JKvy3YkQKOI"> </iframe>
                                            <img width=500 class="img-fluid mb-2 rounded" src="assets/img/lab_assets/lab5_assets/plotForLab5/test_5_cdvsct.png" />
                                            <div class="small text-gray-500">Figure 7:Test 4, Current Distance vs Current Time</div>
                                            <img width=500 class="img-fluid mb-2 rounded" src="assets/img/lab_assets/lab5_assets/plotForLab5/test_5_cmivsct.png" />
                                            <div class="small text-gray-500">Figure 8:Test 4, Current Motor Input vs Current Time</div>

                                            <p> As you can see from the above demo, my PID controller works fine at different distances without making the car hit the wall. </p>

                                            <h3>Wind-up implementation and discussion</h3>
                                            <p>I applied the prevent wind-up mechanism in the design of the PID controller, including integral term timing and integral isolation, 
                                                as shown in the following code.
                                            </p>
                                            <script src="https://gist.github.com/LexLin004/f46c4dadf01e00b2da1ae94f245637fe.js"></script>
                                            <p>If the mechanism of prevent wind-up is not applied, it can be expected that if the distance of the car from the wall is constant, 
                                                the rotational speed of the motor will be faster and faster until the motor input pwm exceeds the upper limit of the motor. 
                                                Even if the distance of the car from the wall is getting smaller, since there is no limit on the accumulated value of the integral term,
                                                it is easy for the car to hitting the wall.
                                            </p>

                                            <hr class="my-5" />
                                            <div class="text-center"><a class="btn btn-transparent-dark" href="fast-robot-all-project-main-page.html">Back to All Reports of Fast Robots Labs</a></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="svg-border-rounded text-dark">
                            <!-- Rounded SVG Border-->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144.54 17.34" preserveAspectRatio="none" fill="currentColor"><path d="M144.54,17.34H0V0H144.54ZM0,0S32.36,17.34,72.27,17.34,144.54,0,144.54,0"></path></svg>
                        </div>
                    </section>
                </main>
            </div>
<div id="layoutDefault_footer">
                <footer class="footer pt-10 pb-5 mt-auto bg-dark footer-dark">
                    <div class="container px-5">
                        <div class="row gx-5">
                            <div class="col-lg-3">
                                <div class="footer-brand">Shihming Lin</div>
                                <div class="mb-3">Portfolio</div>
                                <div class="icon-list-social mb-5">
                                    <a class="icon-list-social-link" href="#!"><i class="fab fa-instagram"></i></a>
                                    <a class="icon-list-social-link" href="#!"><i class="fab fa-facebook"></i></a>
                                    <a class="icon-list-social-link" href="#!"><i class="fab fa-github"></i></a>
                                    <a class="icon-list-social-link" href="#!"><i class="fab fa-twitter"></i></a>
                                </div>
                            </div>
                            <div class="col-lg-9">
                                <div class="row gx-5">
                                    <div class="col-lg-3 col-md-6 mb-5 mb-lg-0">
                                        <div class="text-uppercase-expanded text-xs mb-4">All Info</div>
                                        <ul class="list-unstyled mb-0">
                                            <li class="mb-2"><a href="#!">Projects</a></li>
                                            <li class="mb-2"><a href="#!">Personal</a></li>
                                            <li class="mb-2"><a href="#!">Documentation</a></li>
                                        </ul>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <div class="text-uppercase-expanded text-xs mb-4">Legal</div>
                                        <ul class="list-unstyled mb-0">
                                            <li class="mb-2"><a href="#!">Privacy Policy</a></li>
                                            <li class="mb-2"><a href="#!">Terms and Conditions</a></li>
                                            <li><a href="#!">License</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-5" />
                        <div class="row gx-5 align-items-center">
                            <div class="col-md-6 small">Copyright &copy; LexLin004.github.io 2024</div>
                            <div class="col-md-6 text-md-end small">
                                <a href="#!">Privacy Policy</a>
                                &middot;
                                <a href="#!">Terms &amp; Conditions</a>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="js/scripts.js"></script>
    </body>
</html>
